p8105\_hw6\_jy2944
================
Jie Yu
11/25/2018

-   [Problem 1](#problem-1)
    -   [Import and tidy data](#import-and-tidy-data)
    -   [Fit a logistic regression for one city](#fit-a-logistic-regression-for-one-city)
    -   [Fit logistic regression for each of the cities](#fit-logistic-regression-for-each-of-the-cities)
    -   [Plot showing ORs and CIs for each city](#plot-showing-ors-and-cis-for-each-city)
-   [Problem 2](#problem-2)
    -   [Import and tidy data](#import-and-tidy-data-1)
    -   [Propose a regression model for birthweight](#propose-a-regression-model-for-birthweight)
    -   [Plot of model residuals against fitted values](#plot-of-model-residuals-against-fitted-values)
    -   [Compare models](#compare-models)

Problem 1
=========

### Import and tidy data

Read data through a [GitHub repository](https://github.com/washingtonpost/data-homicides). Create a `city_state` variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. Modifiy `victim_race` to have categories `white` and `non-white`, with `white` as the reference category. Be sure that `victim_age` is numeric.

``` r
# Read data through a Github repo
homicide_data = read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") %>% 
  mutate(
    # Create a `city_state` variable (e.g. “Baltimore, MD”)
    city_state = str_c(city, ",", state),
    # Create a binary variable indicating whether the homicide is solved: 1 - solved; 0 - unsolved
    resolved = as.numeric(disposition == "Closed by arrest")
    ) %>% 
  # Omit some cities
  filter(!city_state %in% c("Dallas,TX","Phoenix,AZ", "Kansas City,MO", "Tulsa,AL")) %>%
  mutate(
    # Modifiy `victim_race` to have categories `white` and `non-white`, with `white` as the reference
    victim_race = fct_relevel(ifelse(victim_race == "White", "white", "non-white"), "white"),
    # Be sure that `victim_age` is numeric
    victim_age = as.numeric(victim_age)
    )
```

### Fit a logistic regression for one city

For the city of Baltimore, MD, use the `glm` function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Save the output of `glm` as an R object; apply the `broom::tidy` to this object; and obtain the estimate and CI of the **adjusted odds ratio** for solving homicides comparing non-white victims to white victims keeping all other variables fixed.

``` r
balti_logistic = homicide_data %>% 
  # filter the city
  filter(city_state == "Baltimore,MD") %>% 
  # Fit a logistic regression: `resolved` as outcome
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) 

balti_logistic %>% 
  broom::tidy() %>% 
  # Obtain odds ratio and its CI
  # Note: logistic model estimates are log odds ratios, so we need to tranform them back
  mutate(
    OR = exp(estimate),
    conf.lower = exp(estimate - std.error * 1.96),
    conf.upper = exp(estimate + std.error * 1.96)
    ) %>%
  select(term, OR, conf.lower, conf.upper, p.value) %>% 
  knitr::kable(digits = 3)
```

| term                  |     OR|  conf.lower|  conf.upper|  p.value|
|:----------------------|------:|-----------:|-----------:|--------:|
| (Intercept)           |  3.274|       2.067|       5.186|    0.000|
| victim\_age           |  0.993|       0.987|       0.999|    0.032|
| victim\_sexMale       |  0.412|       0.315|       0.537|    0.000|
| victim\_racenon-white |  0.441|       0.313|       0.620|    0.000|

The odds ratio for solving solving homicides comparing non-white victims to white victims is 0.441 and the CI is (0.312, 0.620) with 95% confidence interval. It means that homicides in which the victim was non-white were substantially less likely to be resolved than those in which the victim was white (OR = 0.441 &lt; 1, p-value &lt; 0.001). The non-white victims had 0.441 times the odds of having their cases being resolved compared to the white victims. The true odd ratio is between 0.312 and 0.620.

### Fit logistic regression for each of the cities

Now run `glm` for each of the cities in the dataset, and extract the adjusted odds ratio and CI for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of `purrr::map`, list columns, and `unnest` as necessary to create a dataframe with estimated ORs and CIs for each city.

``` r
# Contruct a function `or_and_ci` to calculate OR and CI using `glm` results
or_and_ci = function(df){
    glm = glm(resolved ~ victim_age + victim_sex + victim_race, data = df, family = binomial())
    
    logistic_tidy = glm %>% 
      broom::tidy() %>% 
      mutate(
        OR = exp(estimate),
        conf.lower = exp(estimate - std.error * 1.96),
        conf.upper = exp(estimate + std.error * 1.96)
        ) %>%
      select(term, OR, conf.lower, conf.upper, p.value) %>% 
      # filter the term of non-white victims
      filter(term == "victim_racenon-white") %>% 
      select(-term)
    }

city_logistic = homicide_data %>% 
  # nest the data by each city
  group_by(city_state) %>% 
  nest() %>% 
  # Apply the function `or_and_ci` to each city
  mutate(or_and_ci = map(.x = data, ~or_and_ci(.x))) %>% 
  select(-data) %>% 
  unnest()

city_logistic
## # A tibble: 47 x 5
##    city_state        OR conf.lower conf.upper    p.value
##    <chr>          <dbl>      <dbl>      <dbl>      <dbl>
##  1 Albuquerque,NM 0.741     0.451       1.22  0.238     
##  2 Atlanta,GA     0.753     0.432       1.31  0.317     
##  3 Baltimore,MD   0.441     0.313       0.620 0.00000268
##  4 Baton Rouge,LA 0.668     0.313       1.43  0.296     
##  5 Birmingham,AL  1.04      0.615       1.76  0.886     
##  6 Boston,MA      0.115     0.0472      0.278 0.00000172
##  7 Buffalo,NY     0.390     0.213       0.715 0.00231   
##  8 Charlotte,NC   0.558     0.321       0.969 0.0383    
##  9 Chicago,IL     0.562     0.431       0.733 0.0000207 
## 10 Cincinnati,OH  0.318     0.184       0.551 0.0000428 
## # ... with 37 more rows
```

### Plot showing ORs and CIs for each city

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

``` r
city_logistic %>% 
  # # organize cities according to estimated OR
  mutate(city_state = forcats::fct_reorder(city_state, OR)) %>% 
  # make the plot
  ggplot(aes(x = city_state, y = OR)) + 
  # points represent the ORs for each city
  geom_point(color = "red") + 
  # geom_errorbar(): add error bars based on the upper and lower limits
  geom_errorbar(aes(x = city_state, ymin = conf.lower, ymax = conf.upper)) + 
  labs(
    title = "Estimated ORs and CIs for solving homicides comparing non-white victims to white victims", 
    x = "City", 
    y = "Estimate odds ratio") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

<img src="p8105_hw6_jy2944_files/figure-markdown_github/p1_plot-1.png" width="90%" />

Estimated odds ratio and its confidence interval for solving homices comparing non-white victioms to white victims varies across cities in US. Most of the cities have estimated odds ratios lower than 1, meaning that homicides in which the victim is non-white are less likely to be resolved than those in which the victim is white in US. Boston, MA has the lowest estimated odds ratio while Tampa, FL has the highest estimated odds ratio.

Problem 2
=========

This problem focuses on the effects of several variables on a child's birthweight.

### Import and tidy data

``` r
birth_weight = read_csv("./data/birthweight.csv") %>%
  janitor::clean_names() %>% 
  mutate(
    # convert some categorical data from integer to factor
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace),
    # convert birthweight unit from grams to pounds
    bwt = as.numeric(bwt * 0.00220462)
  )

# Check if there is missing data
skimr::skim(birth_weight )
## Skim summary statistics
##  n obs: 4342 
##  n variables: 20 
## 
## -- Variable type:factor ----------------------------------------------------------------------------------------
##  variable missing complete    n n_unique                      top_counts
##   babysex       0     4342 4342        2         1: 2230, 2: 2112, NA: 0
##     frace       0     4342 4342        5 1: 2123, 2: 1911, 4: 248, 3: 46
##   malform       0     4342 4342        2           0: 4327, 1: 15, NA: 0
##     mrace       0     4342 4342        4 1: 2147, 2: 1909, 4: 243, 3: 43
##  ordered
##    FALSE
##    FALSE
##    FALSE
##    FALSE
## 
## -- Variable type:integer ---------------------------------------------------------------------------------------
##  variable missing complete    n     mean    sd  p0 p25 p50 p75 p100
##     bhead       0     4342 4342  33.65    1.62  21  33  34  35   41
##   blength       0     4342 4342  49.75    2.72  20  48  50  51   63
##     delwt       0     4342 4342 145.57   22.21  86 131 143 157  334
##   fincome       0     4342 4342  44.11   25.98   0  25  35  65   96
##  menarche       0     4342 4342  12.51    1.48   0  12  12  13   19
##   mheight       0     4342 4342  63.49    2.66  48  62  63  65   77
##    momage       0     4342 4342  20.3     3.88  12  18  20  22   44
##    parity       0     4342 4342   0.0023  0.1    0   0   0   0    6
##   pnumlbw       0     4342 4342   0       0      0   0   0   0    0
##   pnumsga       0     4342 4342   0       0      0   0   0   0    0
##      ppwt       0     4342 4342 123.49   20.16  70 110 120 134  287
##    wtgain       0     4342 4342  22.08   10.94 -46  15  22  28   89
##      hist
##  ▁▁▁▁▅▇▁▁
##  ▁▁▁▁▁▇▁▁
##  ▁▇▅▁▁▁▁▁
##  ▁▂▇▂▂▂▁▃
##  ▁▁▁▁▂▇▁▁
##  ▁▁▁▅▇▂▁▁
##  ▂▇▅▂▁▁▁▁
##  ▇▁▁▁▁▁▁▁
##  ▁▁▁▇▁▁▁▁
##  ▁▁▁▇▁▁▁▁
##  ▁▇▆▁▁▁▁▁
##  ▁▁▁▇▇▁▁▁
## 
## -- Variable type:numeric ---------------------------------------------------------------------------------------
##  variable missing complete    n  mean   sd    p0   p25   p50   p75  p100
##       bwt       0     4342 4342  6.87 1.13  1.31  6.19  6.91  7.63 10.56
##   gaweeks       0     4342 4342 39.43 3.15 17.7  38.3  39.9  41.1  51.3 
##     ppbmi       0     4342 4342 21.57 3.18 13.07 19.53 21.03 22.91 46.1 
##    smoken       0     4342 4342  4.15 7.41  0     0     0     5    60   
##      hist
##  ▁▁▁▃▇▇▂▁
##  ▁▁▁▁▃▇▁▁
##  ▁▇▅▁▁▁▁▁
##  ▇▁▁▁▁▁▁▁
```

After importing the data, I convert `babysex`, `frace`, `malform` and `mrace` from integer to factor because they are categorical data. I also convert the unit of `bwt` from grams to pounds to make it consistent with other weitht variables in the dataset. There is no missing data in the dataset.

Now, the explanations of each variable are as follows:

-   `babysex`: baby’s sex (male = 1, female = 2)
-   `bhead`: baby’s head circumference at birth (centimeters)
-   `blength`: baby’s length at birth (centimeteres)
-   `bwt`: baby’s birth weight (pounds)
-   `delwt`: mother’s weight at delivery (pounds)
-   `fincome`: family monthly income (in hundreds, rounded)
-   `frace`: father’s race (1= White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other, 9 = Unknown)
-   `gaweeks`: gestational age in weeks
-   `malform`: presence of malformations that could affect weight (0 = absent, 1 = present)
-   `menarche`: mother’s age at menarche (years)
-   `mheigth`: mother’s height (inches)
-   `momage`: mother’s age at delivery (years)
-   `mrace`: mother’s race (1= White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other)
-   `parity`: number of live births prior to this pregnancy
-   `pnumlbw`: previous number of low birth weight babies
-   `pnumgsa`: number of prior small for gestational age babies
-   `ppbmi`: mother’s pre-pregnancy BMI
-   `ppwt`: mother’s pre-pregnancy weight (pounds)
-   `smoken`: average number of cigarettes smoked per day during pregnancy
-   `wtgain`: mother’s weight gain during pregnancy (pounds)

### Propose a regression model for birthweight

I use backward stepwise regression to select the model. I choose backward search because the MSE tends to be unbiased when important predictors are retained at each step.

``` r
fit_all <- lm(bwt ~ ., data = birth_weight)
step(fit_all, direction = "backward")
## Start:  AIC=-4403.94
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     pnumlbw + pnumsga + ppbmi + ppwt + smoken + wtgain
## 
## 
## Step:  AIC=-4403.94
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     pnumlbw + pnumsga + ppbmi + ppwt + smoken
## 
## 
## Step:  AIC=-4403.94
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     pnumlbw + ppbmi + ppwt + smoken
## 
## 
## Step:  AIC=-4403.94
## bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     ppbmi + ppwt + smoken
## 
##            Df Sum of Sq    RSS     AIC
## - frace     4      0.60 1559.4 -4410.3
## - malform   1      0.01 1558.8 -4405.9
## - ppbmi     1      0.03 1558.9 -4405.9
## - momage    1      0.14 1559.0 -4405.5
## - mheight   1      0.33 1559.2 -4405.0
## - menarche  1      0.54 1559.4 -4404.4
## - ppwt      1      0.64 1559.5 -4404.2
## <none>                  1558.8 -4403.9
## - fincome   1      0.94 1559.8 -4403.3
## - parity    1      2.01 1560.8 -4400.3
## - mrace     3      4.22 1563.0 -4398.2
## - babysex   1      4.15 1563.0 -4394.4
## - gaweeks   1     22.42 1581.2 -4343.9
## - smoken    1     24.67 1583.5 -4337.7
## - delwt     1     38.93 1597.8 -4298.8
## - blength   1    496.00 2054.8 -3206.4
## - bhead     1    517.80 2076.6 -3160.6
## 
## Step:  AIC=-4410.25
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     malform + menarche + mheight + momage + mrace + parity + 
##     ppbmi + ppwt + smoken
## 
##            Df Sum of Sq    RSS     AIC
## - malform   1      0.01 1559.4 -4412.2
## - ppbmi     1      0.03 1559.5 -4412.2
## - momage    1      0.14 1559.6 -4411.9
## - mheight   1      0.34 1559.8 -4411.3
## - menarche  1      0.56 1560.0 -4410.7
## - ppwt      1      0.65 1560.1 -4410.4
## <none>                  1559.4 -4410.3
## - fincome   1      0.94 1560.4 -4409.6
## - parity    1      2.02 1561.5 -4406.6
## - babysex   1      4.14 1563.6 -4400.7
## - gaweeks   1     22.48 1581.9 -4350.1
## - smoken    1     24.48 1583.9 -4344.6
## - delwt     1     38.95 1598.4 -4305.1
## - mrace     3     65.81 1625.2 -4236.8
## - blength   1    495.73 2055.2 -3213.7
## - bhead     1    518.42 2077.9 -3166.0
## 
## Step:  AIC=-4412.23
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     menarche + mheight + momage + mrace + parity + ppbmi + ppwt + 
##     smoken
## 
##            Df Sum of Sq    RSS     AIC
## - ppbmi     1      0.03 1559.5 -4414.1
## - momage    1      0.14 1559.6 -4413.8
## - mheight   1      0.34 1559.8 -4413.3
## - menarche  1      0.56 1560.0 -4412.7
## - ppwt      1      0.65 1560.1 -4412.4
## <none>                  1559.4 -4412.2
## - fincome   1      0.94 1560.4 -4411.6
## - parity    1      2.01 1561.5 -4408.6
## - babysex   1      4.14 1563.6 -4402.7
## - gaweeks   1     22.47 1581.9 -4352.1
## - smoken    1     24.47 1583.9 -4346.6
## - delwt     1     39.02 1598.5 -4306.9
## - mrace     3     65.87 1625.3 -4238.6
## - blength   1    495.80 2055.2 -3215.6
## - bhead     1    518.48 2077.9 -3167.9
## 
## Step:  AIC=-4414.14
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     menarche + mheight + momage + mrace + parity + ppwt + smoken
## 
##            Df Sum of Sq    RSS     AIC
## - momage    1      0.14 1559.6 -4415.7
## - menarche  1      0.57 1560.0 -4414.5
## <none>                  1559.5 -4414.1
## - fincome   1      0.95 1560.4 -4413.5
## - parity    1      2.01 1561.5 -4410.6
## - babysex   1      4.13 1563.6 -4404.7
## - mheight   1      5.24 1564.7 -4401.6
## - ppwt      1     14.26 1573.7 -4376.6
## - gaweeks   1     22.46 1581.9 -4354.0
## - smoken    1     24.49 1584.0 -4348.5
## - delwt     1     39.00 1598.5 -4308.9
## - mrace     3     65.86 1625.3 -4240.5
## - blength   1    495.85 2055.3 -3217.4
## - bhead     1    519.19 2078.7 -3168.4
## 
## Step:  AIC=-4415.74
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     menarche + mheight + mrace + parity + ppwt + smoken
## 
##            Df Sum of Sq    RSS     AIC
## - menarche  1      0.49 1560.1 -4416.4
## <none>                  1559.6 -4415.7
## - fincome   1      1.17 1560.8 -4414.5
## - parity    1      2.10 1561.7 -4411.9
## - babysex   1      4.09 1563.7 -4406.4
## - mheight   1      5.23 1564.8 -4403.2
## - ppwt      1     14.16 1573.8 -4378.5
## - gaweeks   1     22.73 1582.3 -4354.9
## - smoken    1     24.52 1584.1 -4350.0
## - delwt     1     38.89 1598.5 -4310.8
## - mrace     3     71.29 1630.9 -4227.7
## - blength   1    495.71 2055.3 -3219.4
## - bhead     1    519.40 2079.0 -3169.6
## 
## Step:  AIC=-4416.39
## bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
##     mheight + mrace + parity + ppwt + smoken
## 
##           Df Sum of Sq    RSS     AIC
## <none>                 1560.1 -4416.4
## - fincome  1      1.19 1561.3 -4415.1
## - parity   1      2.05 1562.2 -4412.7
## - babysex  1      4.11 1564.2 -4407.0
## - mheight  1      4.92 1565.0 -4404.7
## - ppwt     1     14.13 1574.2 -4379.2
## - gaweeks  1     22.66 1582.8 -4355.8
## - smoken   1     24.66 1584.8 -4350.3
## - delwt    1     39.55 1599.7 -4309.7
## - mrace    3     71.37 1631.5 -4228.2
## - blength  1    496.69 2056.8 -3218.3
## - bhead    1    518.99 2079.1 -3171.5
## 
## Call:
## lm(formula = bwt ~ babysex + bhead + blength + delwt + fincome + 
##     gaweeks + mheight + mrace + parity + ppwt + smoken, data = birth_weight)
## 
## Coefficients:
## (Intercept)     babysex2        bhead      blength        delwt  
##  -1.345e+01    6.296e-02    2.883e-01    1.652e-01    9.054e-03  
##     fincome      gaweeks      mheight       mrace2       mrace3  
##   7.011e-04    2.556e-02    1.454e-02   -3.060e-01   -1.651e-01  
##      mrace4       parity         ppwt       smoken  
##  -2.220e-01    2.123e-01   -5.899e-03   -1.068e-02
```

The "best" model selected by the stepwise backward stepwise regression is `bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken`. We then check colinearity among its predictors using variance inflation factors (VIF), and look at the summary of the model.

``` r
# "best" model selected
fit_best <- lm(bwt ~ babysex + bhead + blength + delwt + fincome + 
                 gaweeks + mheight + mrace + parity + ppwt + smoken, data = birth_weight)

# Identify collinearity among predictors
HH::vif(fit_best)
## babysex2    bhead  blength    delwt  fincome  gaweeks  mheight   mrace2 
## 1.045505 1.826019 1.769732 4.437162 1.205999 1.245075 1.315871 1.415633 
##   mrace3   mrace4   parity     ppwt   smoken 
## 1.027845 1.155101 1.008629 4.345209 1.101300
```

``` r
# summary the model
summary(fit_best)
## 
## Call:
## lm(formula = bwt ~ babysex + bhead + blength + delwt + fincome + 
##     gaweeks + mheight + mrace + parity + ppwt + smoken, data = birth_weight)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.4189 -0.4090 -0.0075  0.3839  5.1884 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -1.345e+01  3.032e-01 -44.340  < 2e-16 ***
## babysex2     6.296e-02  1.864e-02   3.378 0.000737 ***
## bhead        2.883e-01  7.598e-03  37.944  < 2e-16 ***
## blength      1.652e-01  4.451e-03  37.120  < 2e-16 ***
## delwt        9.054e-03  8.643e-04  10.475  < 2e-16 ***
## fincome      7.011e-04  3.853e-04   1.820 0.068844 .  
## gaweeks      2.556e-02  3.223e-03   7.929 2.79e-15 ***
## mheight      1.454e-02  3.935e-03   3.694 0.000223 ***
## mrace2      -3.060e-01  2.184e-02 -14.009  < 2e-16 ***
## mrace3      -1.651e-01  9.329e-02  -1.770 0.076837 .  
## mrace4      -2.220e-01  4.260e-02  -5.210 1.98e-07 ***
## parity       2.123e-01  8.893e-02   2.388 0.017004 *  
## ppwt        -5.899e-03  9.422e-04  -6.261 4.20e-10 ***
## smoken      -1.068e-02  1.291e-03  -8.271  < 2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.6004 on 4328 degrees of freedom
## Multiple R-squared:  0.7181, Adjusted R-squared:  0.7173 
## F-statistic: 848.1 on 13 and 4328 DF,  p-value: < 2.2e-16
```

All of the VIFs calculated for each predictor are lower than 5, indicating that the coefficients might not be misleading due to collinearity. The adjusted *R*<sup>2</sup> is 0.7173, which is good for model building, and most of the predictors have significant coefficient.

### Plot of model residuals against fitted values

Show a plot of model residuals against fitted values – use `add_predictions` and `add_residuals` in making this plot.

``` r
birth_weight %>% 
  modelr::add_predictions(model = fit_best) %>% 
  modelr::add_residuals(model = fit_best) %>%
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Model residuals against fitted values",
        y = "Residual",
        x = "Prediction value"
    )
```

<img src="p8105_hw6_jy2944_files/figure-markdown_github/unnamed-chunk-2-1.png" width="90%" />

The above plot suggests that the residual become higher at lower prediction value, meaning that the model will not fit the data well when the prediction value goes to small.

### Compare models

Compare your model to two others:

-   One using length at birth and gestational age as predictors (main effects only)

-   One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

Make this comparison in terms of the cross-validated prediction error; use `crossv_mc` and functions in `purrr` as appropriate.

``` r
# generate 100 pairs training and testing sets
cv_df = crossv_mc(birth_weight, 100) %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))
  
  
cv_df = cv_df %>% 
  mutate(
    # model_1: the model I selected
    model_1 = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + fincome + 
                 gaweeks + mheight + mrace + parity + ppwt + smoken, data = .x)),
    # model_2: main effects only
    model_2 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    # model_3: including interactions
    model_3 = map(train, ~lm(bwt ~ babysex + blength + bhead + babysex * blength + babysex * bhead + 
                                     blength * bhead + babysex * blength * bhead, data = .x))
        ) %>% 
  mutate(
    rmse_model_1 = map2_dbl(model_1, test, ~rmse(model = .x, data = .y)),
    rmse_model_2 = map2_dbl(model_2, test, ~rmse(model = .x, data = .y)),
    rmse_model_3 = map2_dbl(model_3, test, ~rmse(model = .x, data = .y))
    )

cv_df %>% 
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse, fill = model)) + 
  geom_violin() +
  stat_summary(fun.y = mean, geom = "point", color = "blue", size = 3) + 
  labs(
    title = "The distribution of RMSE values for each model",
    x = "Model",
    y = "RMSE"
    )
```

<img src="p8105_hw6_jy2944_files/figure-markdown_github/unnamed-chunk-3-1.png" width="90%" />

The plot suggests that the model I selected (`model_1`) is a clear winner because it has lowest mean RMSE value and the overall distribution of RMSE values is relatively low. The model using main effects only (`model_2`) is the worst because its RMSE values are really high. The model including three-way intersections(`model_3`) is better than the main effect model because it has a rather lower distribution of RMSE values.
